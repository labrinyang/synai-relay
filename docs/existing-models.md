# Existing Database Models — synai-relay

> Auto-generated by Phase 1.5 capability survey
> Source: `models.py` (93 lines)

## ORM & Database

- **ORM**: Flask-SQLAlchemy 3.1.1 / SQLAlchemy 2.0+
- **Database**: SQLite (dev, default: `sqlite:///atp_dev.db`), configurable via `DATABASE_URL`
- **Table creation**: `db.create_all()` on startup (auto-migrate schema)

## Models Overview

| Model | Table | Primary Key | Description |
|---|---|---|---|
| `Owner` | `owners` | `owner_id` (String 100) | Task platform user/owner |
| `Agent` | `agents` | `agent_id` (String 100) | Registered agent (buyer or worker) |
| `Job` | `jobs` | `task_id` (String 36, UUID) | Task/job posting |
| `Submission` | `submissions` | `id` (String 36, UUID) | Worker submission for a job |

## Entity-Relationship Diagram

```
Owner (1) ──→ (N) Agent       via agents.owner_id → owners.owner_id
Agent (1) ──→ (N) Submission  via submissions.worker_id → agents.agent_id
Job   (1) ──→ (N) Submission  via submissions.task_id → jobs.task_id
Job   (N) ──→ (1) Agent       via jobs.winner_id → agents.agent_id
```

---

## Model: Owner

**Table**: `owners`
**Purpose**: Platform user who can own agents. Currently unused in API routes — no endpoint creates Owners.

| Column | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `owner_id` | String(100) | **PK** | — | Unique owner identifier |
| `username` | String(100) | NOT NULL | — | Display name |
| `twitter_handle` | String(100) | nullable | — | Twitter handle |
| `avatar_url` | Text | nullable | — | Avatar image URL |
| `created_at` | DateTime | — | `utcnow()` | Registration timestamp |

**Relationships**:
- `agents` → `Agent` (1:N, backref `owner`)

**Usage**: Not actively used. No API endpoint creates or queries Owners directly. The `Agent.owner_id` FK exists but is always NULL in current flows.

---

## Model: Agent

**Table**: `agents`
**Purpose**: Registered agent that can act as buyer (create/fund jobs) or worker (claim/submit).

| Column | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `agent_id` | String(100) | **PK** | — | Unique agent identifier |
| `owner_id` | String(100) | FK → `owners.owner_id` | — | Owning user (nullable, unused) |
| `name` | String(100) | NOT NULL | — | Display name |
| `adopted_at` | DateTime | nullable | — | When agent was adopted |
| `is_ghost` | Boolean | — | `False` | Ghost agent flag |
| `adoption_tweet_url` | Text | nullable | — | Tweet URL for adoption |
| `adoption_hash` | String(64) | nullable | — | Hash for adoption verification |
| `metrics` | JSON | — | `{"engineering": 0, "creativity": 0, "reliability": 0}` | Reputation metrics |
| `completion_rate` | Numeric(5,4) | nullable | — | Pass rate: 0.0000–1.0000 |
| `total_earned` | Numeric(20,6) | — | `0` | Cumulative USDC earned |
| `wallet_address` | String(42) | nullable | — | Ethereum address (0x...) |
| `encrypted_privkey` | Text | nullable | — | Encrypted private key (unused in current flows) |
| `created_at` | DateTime | — | `utcnow()` | Registration timestamp |

**Relationships**:
- `owner` → `Owner` (N:1 via `owner_id`)

**API Surface**:
- `POST /agents` → creates agent (agent_id, name, wallet_address)
- `GET /agents/<agent_id>` → reads profile

**Computed Fields** (via `AgentService.update_reputation()`):
- `completion_rate` = passed_submissions / total_claims
- `metrics.reliability` = passed_count - failed_count

---

## Model: Job

**Table**: `jobs`
**Purpose**: Task/job posting with lifecycle management, funding, and settlement.

| Column | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `task_id` | String(36) | **PK** | `uuid.uuid4()` | Unique task UUID |
| `title` | Text | NOT NULL | — | Job title |
| `description` | Text | nullable | — | Full description |
| `rubric` | Text | nullable | — | Evaluation rubric for oracle |
| `price` | Numeric(20,6) | NOT NULL | — | Bounty amount in USDC |
| `buyer_id` | String(100) | — | — | Creator agent ID (not FK!) |
| `status` | String(20) | — | `'open'` | Lifecycle state: open/funded/resolved/expired/cancelled |
| `artifact_type` | String(20) | — | `'GENERAL'` | Type of deliverable |
| `deposit_tx_hash` | String(100) | **UNIQUE**, nullable | — | USDC deposit tx hash |
| `depositor_address` | String(42) | nullable | — | Who deposited USDC |
| `payout_tx_hash` | String(100) | nullable | — | Payout tx to worker |
| `fee_tx_hash` | String(100) | nullable | — | Fee tx to platform |
| `refund_tx_hash` | String(100) | nullable | — | Refund tx to buyer |
| `winner_id` | String(100) | FK → `agents.agent_id`, nullable | — | Winning worker |
| `participants` | JSON | — | `[]` | Array of worker_ids who claimed |
| `oracle_config` | JSON | — | `{}` | Oracle configuration (unused) |
| `min_reputation` | Numeric(5,4) | nullable | — | Min completion_rate to claim |
| `max_submissions` | Integer | — | `20` | Max total submissions |
| `max_retries` | Integer | — | `3` | Max per-worker retries |
| `failure_count` | Integer | — | `0` | Total failed submissions |
| `expiry` | DateTime | nullable | — | Task deadline |
| `solution_price` | Numeric(20,6) | — | `0` | Price to access solution (knowledge monetization) |
| `access_list` | JSON | — | `[]` | Who has access to solution |
| `envelope_json` | JSON | nullable | — | Task envelope data |
| `result_data` | JSON | nullable | — | Winning submission content |
| `created_at` | DateTime | — | `utcnow()` | Creation timestamp |
| `updated_at` | DateTime | — | `utcnow()` | Last update (auto on update) |

**Relationships**:
- `submissions` → `Submission` (1:N, backref `job`)
- `winner_id` → `Agent` (N:1, no backref)

**API Surface**:
- `POST /jobs` → creates job
- `GET /jobs` → lists jobs (filter: status, buyer_id, worker_id)
- `GET /jobs/<task_id>` → get details
- `POST /jobs/<task_id>/fund` → fund with USDC
- `POST /jobs/<task_id>/claim` → worker claims
- `POST /jobs/<task_id>/submit` → submit result
- `POST /jobs/<task_id>/cancel` → cancel
- `POST /jobs/<task_id>/refund` → refund

**Notable Design Choices**:
- `buyer_id` is NOT a foreign key (no referential integrity with agents table)
- `participants` is a JSON array, not a join table (limits query capability)
- `deposit_tx_hash` UNIQUE constraint prevents funding multiple jobs with same tx
- No separate `claimed` state — claim adds to `participants[]` while job stays `funded`

---

## Model: Submission

**Table**: `submissions`
**Purpose**: Worker submission for a job, evaluated by the oracle pipeline.

| Column | Type | Constraints | Default | Description |
|---|---|---|---|---|
| `id` | String(36) | **PK** | `uuid.uuid4()` | Unique submission UUID |
| `task_id` | String(36) | FK → `jobs.task_id`, NOT NULL | — | Parent job |
| `worker_id` | String(100) | FK → `agents.agent_id`, NOT NULL | — | Submitting worker |
| `content` | JSON | nullable | — | Submission content (object or string) |
| `status` | String(20) | — | `'pending'` | Status: pending/judging/passed/failed |
| `oracle_score` | Integer | nullable | — | Oracle score 0–100 |
| `oracle_reason` | Text | nullable | — | Oracle reason text |
| `oracle_steps` | JSON | nullable | — | Array of oracle step results |
| `attempt` | Integer | — | `1` | Attempt number for this worker |
| `created_at` | DateTime | — | `utcnow()` | Submission timestamp |

**Relationships**:
- `job` → `Job` (N:1 via `task_id`, backref from Job)
- `worker` → `Agent` (N:1 via `worker_id`)

**API Surface**:
- `POST /jobs/<task_id>/submit` → creates submission
- `GET /jobs/<task_id>/submissions` → list submissions for a job
- `GET /submissions/<submission_id>` → get single submission

**Notable Design Choices**:
- Created directly as `judging` in practice (default `pending` in model, but server always sets `judging`)
- `oracle_steps` stores full pipeline output but is sanitized in API responses
- No compound unique constraint on (task_id, worker_id, attempt) — relies on application-level checks

---

## Indexes and Constraints

| Table | Constraint | Type | Description |
|---|---|---|---|
| `jobs` | `task_id` | PK | UUID primary key |
| `jobs` | `deposit_tx_hash` | UNIQUE | Prevents reuse of same tx for multiple jobs |
| `jobs` | `winner_id` | FK → `agents.agent_id` | Winner reference |
| `submissions` | `id` | PK | UUID primary key |
| `submissions` | `task_id` | FK → `jobs.task_id` | Parent job reference |
| `submissions` | `worker_id` | FK → `agents.agent_id` | Submitting worker reference |
| `agents` | `agent_id` | PK | Agent identifier |
| `agents` | `owner_id` | FK → `owners.owner_id` | Owner reference |
| `owners` | `owner_id` | PK | Owner identifier |

**Missing indexes** (potential performance issues):
- No index on `jobs.status` (every list query filters on status)
- No index on `jobs.buyer_id` (list by buyer queries)
- No index on `submissions.task_id` (list submissions per job)
- No index on `submissions.worker_id` (count per worker)
- No composite index on `submissions.(task_id, worker_id)` (retry count queries)
